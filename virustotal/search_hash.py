import time
import argparse
import requests
import iocextract


parser = argparse.ArgumentParser()
parser.add_argument("-k", "--apikey", help="Virus Total api key", required = True)
parser.add_argument("-f", "--file", help="File from where to extract the hashes", required = True)
args = parser.parse_args()

url = "https://www.virustotal.com/api/v3/files/"

hash_list = []
    
with open(args.file, 'r') as f:

#    for line in f:
#        hash_list.append(line.split(":")[1])
        
    string = f.read()

    for hash_extracted in iocextract.extract_hashes(string):
        hash_list.append(hash_extracted)

hash_list = list(dict.fromkeys(hash_list))
print("list size: " + str(len(hash_list)))

for hash in hash_list:
    print("hash: " + hash)
    headers = {"x-apikey": args.apikey}

    while True:
        response = requests.get(url + hash, headers=headers)
        
        if response.status_code == 200 or response.status_code == 404:
            break
        
        else:
            time.sleep(10)

    json_data = response.json()

    if "error" in json_data:
    
        with open ("results.txt", 'a') as f:
            f.write(json_data["error"]["message"] + "\n")

    else:

        with open ("results.txt", 'a') as f:
            score = json_data["data"]["attributes"]["last_analysis_stats"]
            f.write("File \"" + hash + "\" malicious: " + str(score["malicious"]) + " undetected: " + str(score["undetected"]) + "\n")
