import time
import argparse
import requests
import iocextract


parser = argparse.ArgumentParser()
parser.add_argument("-k", "--apikey", help="Virus Total api key", required = True)
parser.add_argument("-f", "--file", help="File from where to extract the hashes", required = True)
args = parser.parse_args()

url = "https://www.virustotal.com/api/v3/files/"

hash_list = []
    
with open(args.file, 'r') as f:

#    for line in f:
#        hash_list.append(line.split(":")[1])
        
    string = f.read()

    for hash_extracted in iocextract.extract_hashes(string):
        hash_list.append(hash_extracted)

hash_list = list(dict.fromkeys(hash_list))
print("list size: " + len(hash_list))

for hash in hash_list:
    print("hash: " + hash)
    params = {'apikey': args.key, 'resource': hash}

    while True:
        response = requests.get(url, params=params)
        
        if response.status_code == 200:
            break
        
        else:
            time.sleep(10)

    print(response)
    json_file = response.json()

    if "positives" in json_file:

        with open ("results.txt", 'a') as f:
            f.write("positives: " + str(json_file["positives"]) + "   " + hash + "\n")

    else:
 
        with open ("results.txt", 'a') as f:
            f.write("No matches found: " + hash + "\n")

