import time
import glob
import requests
import iocextract


url = 'https://www.virustotal.com/vtapi/v2/file/report'
apikey = ""

hash_list = []

txt_files = glob.iglob("")

for txt_file in txt_files:
    
    with open(txt_file, 'r') as f:
        
        string = f.read()

        for hash_extracted in iocextract.extract_hashes(string):
            
            hash_list.append(hash_extracted)


'''

        for line in f:

            if "SHA256: " in line:
            
                sha256 = line.split("SHA256: ")[1].split(" ")[0]

                hash_list.append(sha256.rstrip("\n"))

                continue

            if "SHA1: " in line:

                sha1 = line.split("SHA1: ")[1].split(" ")[0]

                hash_list.append(sha1.rstrip("\n"))

                continue

            if "MD5: " in line:

                md5 = line.split("MD5: ")[1].split(" ")[0]

                hash_list.append(md5.rstrip("\n"))

                continue

'''


hash_list = list(dict.fromkeys(hash_list))

for resource in hash_list:

    print(resource)

    params = {'apikey': apikey, 'resource': resource}

    while True:
        
        response = requests.get(url, params=params)
        
        if response.status_code == 200:
            break
        
        else:
            time.sleep(10)

    print(response)

    json_file = response.json()

    for key, value in json_file.items():

        if key == "positives":

            with open ("results.txt", 'a') as f:
                f.write(str(key) + ": " + str(value) + "   " + resource + "\n")

        else:
 
            with open ("results.txt", 'a') as f:
                f.write("No matches found: " + resource + "\n")

