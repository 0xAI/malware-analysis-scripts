import argparse
import base64
import re

parser = argparse.ArgumentParser()
parser.add_argument("-b", "--base64", help="base64 string", required=True)
args = parser.parse_args()

powershell_code = base64.b64decode(args.base64).decode("utf-8")
formatted_code = powershell_code.replace("\00", "").replace(";", ";\n").replace("'http", "'\n\n\thttp").replace("/'.", 
        "/\n\n'.").replace("*http", "\n\thttp")

with open ("emotet_iocs.txt", 'a') as f:
    f.write("Deobfuscated macro: \n\n")
    f.write(formatted_code)
    f.write("\n\n\n")
    f.write("Extracted IOCs: \n\n")

urls = re.findall('http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', formatted_code)

for url in urls:

    safe_url = url.replace("http", "hxxp").replace("https", "hxxps").replace(".", "[.]")

    with open ("emotet_iocs.txt", 'a') as f:
        f.write("url: " + safe_url + "\n")
